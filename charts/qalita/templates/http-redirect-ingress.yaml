{{- if .Values.httpRedirect.enabled }}
{{- $releaseName := .Release.Name -}}
{{- $chartName := .Chart.Name -}}
{{- $chartVersion := .Chart.Version -}}
{{- $releaseService := .Release.Service -}}
{{- $namespace := .Release.Namespace -}}
{{- $clusterDomain := .Values.cluster.domain -}}

# =============================================================================
# HTTP to HTTPS Redirect Middlewares
# =============================================================================

{{- if .Values.httpRedirect.frontend.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: "{{ $releaseName }}-frontend-https-redirect"
  labels:
    app: "{{ $releaseName }}-frontend"
    chart: "{{ $chartName }}-{{ $chartVersion }}"
    heritage: {{ $releaseService }}
    release: {{ $releaseName }}
spec:
  redirectScheme:
    scheme: https
    permanent: true
{{- end }}

{{- if .Values.httpRedirect.api.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: "{{ $releaseName }}-api-https-redirect"
  labels:
    app: "{{ $releaseName }}-backend"
    chart: "{{ $chartName }}-{{ $chartVersion }}"
    heritage: {{ $releaseService }}
    release: {{ $releaseName }}
spec:
  redirectScheme:
    scheme: https
    permanent: true
{{- end }}

{{- if and .Values.doc.enabled .Values.httpRedirect.doc.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: "{{ $releaseName }}-doc-https-redirect"
  labels:
    app: "{{ $releaseName }}-doc"
    chart: "{{ $chartName }}-{{ $chartVersion }}"
    heritage: {{ $releaseService }}
    release: {{ $releaseName }}
spec:
  redirectScheme:
    scheme: https
    permanent: true
{{- end }}

# =============================================================================
# HTTP to HTTPS Redirect Ingresses
# =============================================================================

{{- if .Values.httpRedirect.frontend.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "{{ $releaseName }}-frontend-http-redirect"
  labels:
    app: "{{ $releaseName }}-frontend"
    chart: "{{ $chartName }}-{{ $chartVersion }}"
    heritage: {{ $releaseService }}
    release: {{ $releaseName }}
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    traefik.ingress.kubernetes.io/router.middlewares: {{ $namespace }}-{{ $releaseName }}-frontend-https-redirect@kubernetescrd
    {{- with .Values.httpRedirect.frontend.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  rules:
    - host: {{ $clusterDomain }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $releaseName }}-frontend-service
                port:
                  name: 3000tcp
{{- end }}

{{- if .Values.httpRedirect.api.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "{{ $releaseName }}-api-http-redirect"
  labels:
    app: "{{ $releaseName }}-backend"
    chart: "{{ $chartName }}-{{ $chartVersion }}"
    heritage: {{ $releaseService }}
    release: {{ $releaseName }}
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    traefik.ingress.kubernetes.io/router.middlewares: {{ $namespace }}-{{ $releaseName }}-api-https-redirect@kubernetescrd
    {{- with .Values.httpRedirect.api.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  rules:
    - host: api.{{ $clusterDomain }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $releaseName }}-backend-service
                port:
                  name: rest
{{- end }}

{{- if and .Values.doc.enabled .Values.httpRedirect.doc.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "{{ $releaseName }}-doc-http-redirect"
  labels:
    app: "{{ $releaseName }}-doc"
    chart: "{{ $chartName }}-{{ $chartVersion }}"
    heritage: {{ $releaseService }}
    release: {{ $releaseName }}
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    traefik.ingress.kubernetes.io/router.middlewares: {{ $namespace }}-{{ $releaseName }}-doc-https-redirect@kubernetescrd
    {{- with .Values.httpRedirect.doc.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  rules:
    - host: doc.{{ $clusterDomain }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $releaseName }}-doc-service
                port:
                  name: 80tcp
{{- end }}

{{- end }}
