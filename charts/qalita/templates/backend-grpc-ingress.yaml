{{- if and .Values.backend.grpc.enabled .Values.backend.grpc.ingress.enabled -}}
{{- $serviceName := print .Release.Name "-backend-service" }}

# Traefik IngressRoute for gRPC - required for proper HTTP/2 (h2c) backend communication
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: "{{ .Release.Name }}-backend-grpc-ingressroute"
  labels:
    app: "{{ .Release.Name }}-backend"
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
{{- if .Values.backend.grpc.ingress.annotations }}
  annotations:
{{ toYaml .Values.backend.grpc.ingress.annotations | indent 4 }}
{{- end }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`grpc.{{ .Values.cluster.domain }}`)
      kind: Rule
      services:
        - name: {{ $serviceName }}
          port: {{ .Values.backend.grpc.port }}
          scheme: h2c
{{- if .Values.backend.grpc.ingress.tls.enabled }}
  tls:
    secretName: grpc-cert
{{- end }}
---
# Certificate for gRPC endpoint
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: grpc-cert
  labels:
    app: "{{ .Release.Name }}-backend"
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
spec:
  secretName: grpc-cert
  issuerRef:
    name: {{ .Values.cluster.issuer }}
    kind: ClusterIssuer
  dnsNames:
    - grpc.{{ .Values.cluster.domain }}
{{- end -}}
